name: backend_pipeline

on: [push, pull_request]

jobs:
  test:
    runs-on: ubuntu-latest

    env:
      SECRET_KEY: ${{ secrets.SECRET_KEY }}
      ALGORITHM: ${{ secrets.ALGORITHM }}
      ACCESS_TOKEN_EXPIRE_MINUTES: ${{ secrets.ACCESS_TOKEN_EXPIRE_MINUTES }}
      CORS_ORIGINS: ${{ secrets.CORS_ORIGINS }}
      DATABASE_URL: postgresql+psycopg://fake:fake@localhost:5432/fake
      ENV: test

    steps:
      - uses: actions/checkout@v4

      - name: Instalar Python
        uses: actions/setup-python@v6
        with:
          python-version: "3.13"

      - name: Instalar uv
        run: pipx install uv

      - name: Cache uv
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/uv
            backend/.venv
          key: uv-${{ runner.os }}-${{ hashFiles('backend/uv.lock') }}

      - name: Instalar dependÃªncias
        working-directory: backend
        run: uv sync

      - name: Rodar testes
        working-directory: backend
        run: uv run task test
